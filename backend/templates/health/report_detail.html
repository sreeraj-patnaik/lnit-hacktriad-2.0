{% extends "base.html" %}
{% block title %}Report Detail | Aarogya Health Command{% endblock %}
{% block content %}
<section class="hero-card report-hero">
    <div>
        <p class="eyebrow">Report Detail</p>
        <h1>Scan from {{ report.report_date }}</h1>
        <p class="hero-copy">
            Parameter extraction, trend interpretation, and doctor-style narrative are combined below.
        </p>
    </div>
    <div class="patient-chip">
        <p><strong>Source:</strong>
            {% if report.report_file %}
                <a href="{{ report.report_file.url }}" target="_blank">Open uploaded file</a>
            {% else %}
                Text input mode
            {% endif %}
        </p>
        <p><strong>Analysis:</strong>
            {% if report.analysis_completed %}
                <span class="tag success">Completed</span>
            {% else %}
                <span class="tag neutral">Pending</span>
            {% endif %}
        </p>
    </div>
</section>

<section class="panel">
    <div class="panel-head">
        <h3>Extracted Lab Parameters</h3>
        <p>Color coding highlights where immediate review may be needed.</p>
    </div>
    {% if parameters %}
        <div class="table-wrap">
            <table class="report-table">
                <thead>
                <tr>
                    <th>Parameter</th>
                    <th>Value</th>
                    <th>Reference Range</th>
                    <th>Risk</th>
                </tr>
                </thead>
                <tbody>
                {% for p in parameters %}
                    <tr>
                        <td>{{ p.name }}</td>
                        <td>{{ p.value }} {{ p.unit }}</td>
                        <td>{{ p.ref_min }} - {{ p.ref_max }}</td>
                        <td>
                            {% if p.risk_flag == "high" %}
                                <span class="tag danger">High</span>
                            {% elif p.risk_flag == "low" %}
                                <span class="tag warning">Low</span>
                            {% elif p.risk_flag == "normal" %}
                                <span class="tag success">Normal</span>
                            {% else %}
                                <span class="tag neutral">Unknown</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="empty-state">No parameters were extracted from this upload.</p>
    {% endif %}
</section>

{% if trend_series %}
<section class="panel">
    <div class="panel-head">
        <h3>Graphical Trend Analysis</h3>
        <p>Visual trend lines with color-coded highlights from your past scans to this report.</p>
    </div>
    <div class="trend-grid">
        {% for series in trend_series %}
            <article class="trend-card">
                <div class="trend-top">
                    <div>
                        <h4>{{ series.name }}</h4>
                        <p class="trend-meta">{{ series.point_count }} data points | {{ series.first_date }} to {{ series.last_date }}</p>
                    </div>
                    <div class="trend-stats">
                        <p class="trend-value">{{ series.latest_value }} {{ series.unit }}</p>
                        {% if series.delta is not None %}
                            {% if series.direction == "up" %}
                                <span class="tag {% if series.latest_risk == 'high' %}danger{% else %}warning{% endif %}">&#9650; {{ series.delta }}</span>
                            {% elif series.direction == "down" %}
                                <span class="tag {% if series.latest_risk == 'low' %}warning{% else %}success{% endif %}">&#9660; {{ series.delta|floatformat:2|cut:"-" }}</span>
                            {% else %}
                                <span class="tag neutral">No change</span>
                            {% endif %}
                        {% else %}
                            <span class="tag neutral">First reading</span>
                        {% endif %}
                    </div>
                </div>
                <svg class="sparkline risk-{{ series.latest_risk }}" data-trend-index="{{ forloop.counter0 }}" viewBox="0 0 220 72" aria-label="{{ series.name }} trend graph"></svg>
                <div class="trend-axis">
                    <span>{{ series.first_date }}</span>
                    <span>{{ series.last_date }}</span>
                </div>
            </article>
        {% endfor %}
    </div>
</section>
{{ trend_series|json_script:"trend-series-data" }}
{% endif %}

{% if report.doctor_suggestions %}
<section class="panel">
    <div class="panel-head">
        <h3>Doctor Suggestions Found in Report</h3>
        <p>Non-tabular notes and clinician comments parsed from the uploaded text.</p>
    </div>
    <ul class="notes-list">
        {% for note in report.doctor_suggestions %}
            <li>{{ note }}</li>
        {% endfor %}
    </ul>
</section>
{% endif %}

{% if analysis %}
<section class="panel">
    <div class="panel-head">
        <h3>Personalized Clinical Interpretation</h3>
        <p>Single integrated, context-aware explanation from your profile, history, trends, and latest report.</p>
    </div>
    <article class="analysis-block">
        <h4>Full Narrative</h4>
        <p id="full-narrative-text">{{ full_narrative }}</p>
    </article>
    {% if full_narrative %}
    <article class="analysis-block tts-panel">
        <h4>Listen to This Interpretation</h4>
        <p class="trend-meta">Change language to auto-translate the narrative and play in the selected voice.</p>
        <div class="tts-controls">
            <label for="tts-language">Language</label>
            <select id="tts-language">
                <option value="en-IN">English (India)</option>
                <option value="en-US">English (US)</option>
                <option value="hi-IN">Hindi</option>
                <option value="ta-IN">Tamil</option>
                <option value="te-IN">Telugu</option>
                <option value="kn-IN">Kannada</option>
                <option value="ml-IN">Malayalam</option>
                <option value="bn-IN">Bengali</option>
                <option value="mr-IN">Marathi</option>
                <option value="gu-IN">Gujarati</option>
                <option value="pa-IN">Punjabi</option>
                <option value="ur-IN">Urdu</option>
                <option value="es-ES">Spanish</option>
                <option value="fr-FR">French</option>
                <option value="de-DE">German</option>
            </select>
            <button type="button" class="btn-primary" id="tts-play">Play</button>
            <button type="button" class="btn-quiet" id="tts-pause">Pause</button>
            <button type="button" class="btn-quiet" id="tts-stop">Stop</button>
        </div>
        <p id="tts-status" class="trend-meta"></p>
    </article>
    {{ full_narrative|json_script:"tts-narrative-text" }}
    {% endif %}
</section>
{% else %}
<section class="panel">
    <p class="empty-state">Analysis is not available yet for this report.</p>
</section>
{% endif %}

{% if report.ocr_text %}
<section class="panel">
    <div class="panel-head">
        <h3>Input / OCR Capture</h3>
        <p>Raw extracted text used as analysis input.</p>
    </div>
    <pre class="ocr-block">{{ report.ocr_text }}</pre>
</section>
{% endif %}
<script>
    (function () {
        const payload = document.getElementById("trend-series-data");
        if (!payload) return;

        let trendData = [];
        try {
            trendData = JSON.parse(payload.textContent);
        } catch (e) {
            return;
        }

        const ns = "http://www.w3.org/2000/svg";
        const charts = document.querySelectorAll(".sparkline[data-trend-index]");
        charts.forEach((chart) => {
            const index = Number(chart.getAttribute("data-trend-index"));
            const series = trendData[index];
            const points = (series && series.points) ? series.points : [];
            if (!points.length) return;

            const width = 220;
            const height = 72;
            const padX = 8;
            const padY = 8;
            const values = points.map((item) => Number(item.value));
            const min = Math.min(...values);
            const max = Math.max(...values);
            const range = (max - min) || 1;

            const coords = values.map((value, i) => {
                const x = padX + ((width - (2 * padX)) * (points.length === 1 ? 0.5 : i / (points.length - 1)));
                const y = (height - padY) - ((value - min) / range) * (height - (2 * padY));
                return { x, y };
            });

            const polyline = document.createElementNS(ns, "polyline");
            polyline.setAttribute("fill", "none");
            polyline.setAttribute("stroke-width", "2.8");
            polyline.setAttribute("stroke-linecap", "round");
            polyline.setAttribute("stroke-linejoin", "round");
            polyline.setAttribute("points", coords.map((c) => `${c.x},${c.y}`).join(" "));
            chart.appendChild(polyline);

            coords.forEach((coord, idx) => {
                const circle = document.createElementNS(ns, "circle");
                circle.setAttribute("cx", String(coord.x));
                circle.setAttribute("cy", String(coord.y));
                circle.setAttribute("r", idx === coords.length - 1 ? "3.6" : "2.2");
                chart.appendChild(circle);
            });
        });
    })();

    (function () {
        const textNode = document.getElementById("tts-narrative-text");
        const narrativeNode = document.getElementById("full-narrative-text");
        const languageSelect = document.getElementById("tts-language");
        const playBtn = document.getElementById("tts-play");
        const pauseBtn = document.getElementById("tts-pause");
        const stopBtn = document.getElementById("tts-stop");
        const status = document.getElementById("tts-status");
        if (!textNode || !narrativeNode || !languageSelect || !playBtn || !pauseBtn || !stopBtn || !status) return;
        if (!("speechSynthesis" in window) || !("SpeechSynthesisUtterance" in window)) {
            status.textContent = "Text-to-speech is not supported in this browser.";
            playBtn.disabled = true;
            pauseBtn.disabled = true;
            stopBtn.disabled = true;
            return;
        }

        let voices = [];
        let utterance = null;
        let activeSession = 0;
        const originalNarrative = (JSON.parse(textNode.textContent) || "").trim();
        let activeNarrative = originalNarrative;
        const translationCache = { "en": originalNarrative };

        const defaultLang = "{{ tts_default_lang|default:'en-IN'|escapejs }}";
        if (defaultLang) {
            const options = Array.from(languageSelect.options).map((opt) => opt.value);
            if (options.includes(defaultLang)) {
                languageSelect.value = defaultLang;
            }
        }

        function loadVoices() {
            voices = window.speechSynthesis.getVoices() || [];
        }
        loadVoices();
        window.speechSynthesis.onvoiceschanged = loadVoices;

        function pickVoice(lang) {
            const lower = (lang || "").toLowerCase();
            const exact = voices.find((v) => (v.lang || "").toLowerCase() === lower);
            if (exact) return exact;
            const prefix = lower.split("-")[0];
            return voices.find((v) => (v.lang || "").toLowerCase().startsWith(prefix)) || null;
        }

        function stopCurrent() {
            activeSession += 1;
            window.speechSynthesis.cancel();
            utterance = null;
        }

        function getCookie(name) {
            const cookieValue = document.cookie
                .split(";")
                .map((item) => item.trim())
                .find((item) => item.startsWith(name + "="));
            if (!cookieValue) return "";
            return decodeURIComponent(cookieValue.split("=").slice(1).join("="));
        }

        function normalizeLang(code) {
            return String(code || "en").toLowerCase().split("-")[0];
        }

        async function translateNarrative(langCode) {
            const normalized = normalizeLang(langCode);
            if (translationCache[normalized]) {
                return translationCache[normalized];
            }
            status.textContent = "Translating narrative...";
            const response = await fetch("{% url 'report-translate' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify({
                    text: originalNarrative,
                    source_lang: "en",
                    target_lang: langCode,
                }),
            });
            const payload = await response.json();
            if (!response.ok) {
                throw new Error(payload.error || "Translation failed");
            }
            const translated = (payload.translated_text || "").trim() || originalNarrative;
            translationCache[normalized] = translated;
            return translated;
        }

        function splitForSpeech(text, maxLen) {
            const source = String(text || "").replace(/\s+/g, " ").trim();
            if (!source) return [];
            const sentenceChunks = source.match(/[^.!?]+[.!?]*/g) || [source];
            const result = [];
            sentenceChunks.forEach((sentence) => {
                const part = sentence.trim();
                if (!part) return;
                if (part.length <= maxLen) {
                    result.push(part);
                    return;
                }
                const words = part.split(" ");
                let current = "";
                words.forEach((word) => {
                    const candidate = current ? (current + " " + word) : word;
                    if (candidate.length > maxLen && current) {
                        result.push(current);
                        current = word;
                    } else {
                        current = candidate;
                    }
                });
                if (current) result.push(current);
            });
            return result;
        }

        function pickFallbackVoice() {
            return (
                pickVoice("en-IN") ||
                pickVoice("en-US") ||
                voices.find((v) => (v.lang || "").toLowerCase().startsWith("en")) ||
                null
            );
        }

        function speakChunkSequence(text, lang) {
            const sessionId = ++activeSession;
            const chunks = splitForSpeech(text, 220);
            if (!chunks.length) {
                status.textContent = "No narrative available for playback.";
                return;
            }

            const preferredVoice = pickVoice(lang);
            const fallbackVoice = pickFallbackVoice();

            function speakAt(index, useFallback) {
                if (sessionId !== activeSession) return;
                if (index >= chunks.length) {
                    status.textContent = "Narration completed.";
                    return;
                }
                const chunkText = chunks[index];
                utterance = new SpeechSynthesisUtterance(chunkText);
                utterance.lang = useFallback ? "en-IN" : (lang || "en-IN");
                utterance.rate = 0.96;
                utterance.pitch = 1;
                if (useFallback && fallbackVoice) {
                    utterance.voice = fallbackVoice;
                } else if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }
                utterance.onstart = function () {
                    if (sessionId !== activeSession) return;
                    status.textContent = "Playing narration...";
                };
                utterance.onend = function () {
                    speakAt(index + 1, useFallback);
                };
                utterance.onerror = function () {
                    if (sessionId !== activeSession) return;
                    if (!useFallback && fallbackVoice) {
                        status.textContent = "Selected voice unavailable. Switching to fallback voice.";
                        speakAt(index, true);
                        return;
                    }
                    status.textContent = "Playback failed on this browser voice. Try another language.";
                };
                window.speechSynthesis.speak(utterance);
            }

            speakAt(0, false);
        }

        languageSelect.addEventListener("change", async function () {
            const selected = languageSelect.value || "en-IN";
            const normalized = normalizeLang(selected);
            stopCurrent();
            if (normalized === "en") {
                activeNarrative = originalNarrative;
                narrativeNode.textContent = activeNarrative;
                status.textContent = "Showing original English narrative.";
                return;
            }
            try {
                const translatedText = await translateNarrative(selected);
                activeNarrative = translatedText;
                narrativeNode.textContent = activeNarrative;
                status.textContent = "Narrative translated.";
            } catch (error) {
                activeNarrative = originalNarrative;
                narrativeNode.textContent = activeNarrative;
                status.textContent = "Translation failed. Showing original English text.";
            }
        });

        playBtn.addEventListener("click", function () {
            if (!activeNarrative) {
                status.textContent = "No narrative available for playback.";
                return;
            }
            stopCurrent();
            const lang = languageSelect.value || "en-IN";
            speakChunkSequence(activeNarrative, lang);
        });

        pauseBtn.addEventListener("click", function () {
            if (window.speechSynthesis.speaking && !window.speechSynthesis.paused) {
                window.speechSynthesis.pause();
                status.textContent = "Narration paused.";
            } else if (window.speechSynthesis.paused) {
                window.speechSynthesis.resume();
                status.textContent = "Narration resumed.";
            }
        });

        stopBtn.addEventListener("click", function () {
            stopCurrent();
            status.textContent = "Narration stopped.";
        });
    })();
</script>
{% endblock %}
